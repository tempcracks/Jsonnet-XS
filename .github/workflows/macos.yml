name: macos

on:
  push:
  pull_request:

jobs:
  macos:
    runs-on: macos-latest

    strategy:
      fail-fast: false
      matrix:
        perl: ['5.30', '5.32', '5.34','5.36', '5.38', '5.40', '5.42']

    name: Perl ${{ matrix.perl }} on MacOS

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Platform check
        run: |
          uname -a
      - name: Set up Perl
        uses: shogo82148/actions-setup-perl@v1
        with:
          perl-version: ${{ matrix.perl }}
          enable-modules-cache: false   # можно true, если добавишь cpanfile
      - name: Perl version check
        run: |
          perl -V
      
      - name: Prepare cpan
        run: |
          cpan -M https://www.cpan.org -T App::cpanminus
          cpanm --notest  ${{ vars.EXTRA_CPANM_MODULES }} ${{ vars.MACOS_EXTRA_CPANM_MODULES }}

      - name: Install configure deps
        run: |
          cpanm --notest \
              Devel::CheckLib \
              JSON::MaybeXS \
              Test2::V0 \
              Test::Pod \
              Test::Pod::Coverage \
              Test::CPAN::Meta
              
      - name: Install libjsonnet v0.21.0
        run: |
          brew update
          brew update-reset
          brew cleanup
          brew upgrade cmake
          cmake --version
          cd /tmp
          git clone  https://github.com/tempcracks/jsonnet.git
          cd jsonnet
          mkdir build
          cd build
          cmake ..
      - name: output makefile
        run: |
          #cat /tmp/jsonnet/build/Makefile
          cd /tmp/jsonnet/build
          make
          sudo make install
          ls -la .

      - name: Build
        run: |
          export LIBRARY_PATH="/usr/local/lib:$LIBRARY_PATH"
          export DYLD_LIBRARY_PATH="/usr/local/lib:$DYLD_LIBRARY_PATH"
          export CPATH="/usr/local/include:$CPATH"
          perl Makefile.PL
          make

      - name: Run tests
        run: |
          make test
