name: windows

on:
  push:
  pull_request:

jobs:
    perl:
      environment: automated_testing
      runs-on: windows-2022
      strategy:
        matrix:
          perl: ['5.30', '5.32', '5.34','5.36', '5.38', '5.40', '5.42']

      steps:
        - run: git config --global core.autocrlf false
        - uses: actions/checkout@v4

        - name: git corrections
          run: |
            git config --global --add safe.directory "${{ github.workspace }}"  
        - name: Set up Perl
          run: |
            #choco uninstall strawberryperl
            #choco upgrade strawberryperl
            echo "C:\strawberry\c\bin"  | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            echo "C:\strawberry\perl\site\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            echo "C:\strawberry\perl\bin"      | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
        - name: Perl version
          run: |
            perl -V

        - name: Install cpanm and multiple modules
          run: |
              cpan -M http://www.cpan.org -T App::cpanminus ${{ vars.EXTRA_CPAN_MODULES }}
              cpanm --notest Devel::CheckLib JSON::MaybeXS Test2::V0 Test::Pod Test::Pod::Coverage Test::CPAN::Meta
              
        - name: Install jsonnet
          run: |
            $version = "master"
            $url = "https://github.com/tempcracks/jsonnet/archive/refs/heads/master.zip"
            $zipPath = "$env:RUNNER_TEMP\$version.zip"
            $extractDir = "$env:RUNNER_TEMP\jsonnet-src"
        
            # Download source
            Invoke-WebRequest -Uri $url -OutFile $zipPath
        
            # Extract
            Expand-Archive -Path $zipPath -DestinationPath $extractDir -Force
        
            # Build location
            $sourceDir = "$extractDir\jsonnet-$version"
            echo "SOURCE_DIR=$sourceDir" >> $env:GITHUB_ENV
    
        - name: Install cmake
          shell: powershell
          run: |
            $cmakeVersion = "4.2.1"
        
            winget show Kitware.CMake --versions 2>$null | Select-String $cmakeVersion
        
            if ($LASTEXITCODE -eq 0) {
              Write-Host "Found $cmakeVersion in winget, installing..." -ForegroundColor Green
              winget install --id Kitware.CMake --version $cmakeVersion --exact --silent --accept-package-agreements --accept-source-agreements
              
            } else {
              Write-Host "CMake $cmakeVersion not in winget, downloading from URL..." -ForegroundColor Yellow
            
            # Download from GitHub release URL
            $url = "https://github.com/Kitware/CMake/releases/download/v$cmakeVersion/cmake-$cmakeVersion-windows-x86_64.zip"
            $installDir = "C:\Program Files\CMake"
            
            # Create temp directory
            $tempDir = "$env:TEMP\cmake-$cmakeVersion"
            New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
            
            # Download
            Write-Host "Downloading from: $url" -ForegroundColor Cyan
            Invoke-WebRequest -Uri $url -OutFile "$tempDir\cmake.zip" -UseBasicParsing
            
            # Extract
            Write-Host "Extracting to: $installDir" -ForegroundColor Cyan
            Expand-Archive -Path "$tempDir\cmake.zip" -DestinationPath $installDir -Force
            
            # Add to PATH (like winget would)
            $cmakeBin = "$installDir\cmake-$cmakeVersion-windows-x86_64\bin"
            $env:Path = "$cmakeBin;$env:Path"
            
            # Add to system PATH for current user (like winget install would)
            [Environment]::SetEnvironmentVariable("Path", "$cmakeBin;" + [Environment]::GetEnvironmentVariable("Path", "User"), "User")
            
            # Cleanup
            Remove-Item -Path $tempDir -Recurse -Force -ErrorAction SilentlyContinue
            
            Write-Host "CMake $cmakeVersion installed manually" -ForegroundColor Green
            }
            $cmakeBin = "C:\Program Files\CMake\cmake-$cmakeVersion-windows-x86_64\bin"
            $env:Path = "$cmakeBin;$env:Path"
            
            
        - name: Build Jsonnet
          shell: powershell
          run: |
            cd $env:SOURCE_DIR
        
            # Create build directory
            mkdir build
            cd build
        
            # Configure with CMake
            cmake .. -DCMAKE_BUILD_TYPE=Release
        
            # Build
            cmake --build . --config Release --target jsonnet
        
            # Verify
            .\Release\jsonnet.exe --version
        
            # Copy to location in PATH
            $installDir = "C:\jsonnet"
            New-Item -ItemType Directory -Force -Path $installDir
            Copy-Item .\Release\jsonnet.exe $installDir\
        
            # Add to PATH
            echo $installDir >> $env:GITHUB_PATH

        - name: Install dependencies
          run: |
            cpan -M https://www.cpan.org -T .
        - name: Build
          run: |
              perl Makefile.PL
              make
        - name: Run tests
          run: |
              make test

